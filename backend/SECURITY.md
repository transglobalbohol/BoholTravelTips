# Enhanced Security Configuration - Bohol Travel Tips Backend\n\n## Overview\n\nThis backend implementation includes comprehensive security measures following OWASP Top 10 guidelines and industry best practices. The security stack includes advanced Helmet.js configurations and enhanced JWT authentication.\n\n## Security Features Implemented\n\n### 1. Advanced Helmet.js Configuration\n\n**Location**: `middleware/advancedSecurity.js`\n\n**Features**:\n- **Content Security Policy (CSP)** - Prevents XSS attacks by controlling resource loading\n- **HTTP Strict Transport Security (HSTS)** - Forces HTTPS connections\n- **X-Frame-Options** - Prevents clickjacking attacks\n- **X-Content-Type-Options** - Prevents MIME sniffing attacks\n- **Referrer Policy** - Controls referrer information disclosure\n- **Cross-Origin Policies** - Enhanced CORS protection\n\n**Custom Security Headers**:\n- API versioning headers\n- Rate limit policy headers\n- Cache control for sensitive endpoints\n- Server fingerprinting protection\n\n### 2. Enhanced JWT Authentication\n\n**Location**: `middleware/advancedSecurity.js`, `middleware/auth.js`, `controllers/authController.js`\n\n**Features**:\n- **Multi-layered token validation** with issuer/audience verification\n- **IP address binding** (optional - configurable via VERIFY_IP_ADDRESS)\n- **User agent verification** (optional - configurable via VERIFY_USER_AGENT)\n- **Session management** with unique session IDs\n- **Token versioning** for future compatibility\n- **Enhanced security claims** including account status and 2FA status\n- **Algorithm specification** (HS256) to prevent algorithm confusion attacks\n\n### 3. Rate Limiting Enhancement\n\n**Features**:\n- **Advanced key generation** combining IP and user ID\n- **Whitelisted IP support** for trusted sources\n- **Different limits** for different endpoint types\n- **Security event logging** for rate limit violations\n\n### 4. Security Monitoring\n\n**Features**:\n- **Suspicious pattern detection** for common attack vectors\n- **Real-time security event logging** with severity levels\n- **Request context tracking** with unique request IDs\n- **Automated threat detection** for SQL injection, XSS, and directory traversal\n\n### 5. Input Validation & Sanitization\n\n**Features**:\n- **MongoDB injection protection** using express-mongo-sanitize\n- **XSS protection** with custom sanitization functions\n- **HTTP Parameter Pollution (HPP) protection**\n- **DOMPurify integration** for HTML sanitization\n- **Comprehensive validation** using express-validator\n\n## Configuration\n\n### Environment Variables\n\nCopy `.env.security` to `.env` and configure:\n\n```bash\n# Required - Strong JWT secret (at least 64 characters)\nJWT_SECRET=your-super-secure-jwt-secret-at-least-64-characters-long\n\n# Optional - Enhanced security features\nVERIFY_IP_ADDRESS=false  # Enable IP verification\nVERIFY_USER_AGENT=false  # Enable User-Agent verification\nWHITELISTED_IPS=127.0.0.1,::1  # Trusted IPs for rate limiting\n```\n\n### Security Headers Configuration\n\nThe advanced Helmet configuration can be customized in `advancedSecurity.js`:\n\n```javascript\nconst advancedHelmetConfig = helmet({\n  contentSecurityPolicy: {\n    directives: {\n      defaultSrc: [\"'self'\"],\n      // Add your domains here\n    }\n  }\n});\n```\n\n## Security Endpoints\n\n### Health Check with Security Status\n```\nGET /api/health\n```\nReturns server status including security feature status.\n\n### Security Status\n```\nGET /api/security/status\n```\nReturns public security features information.\n\n### CSP Violation Reporting\n```\nPOST /api/security/csp-report\n```\nReceives CSP violation reports for security monitoring.\n\n## Security Logging\n\n### Log Levels\n- **INFO**: General security events (login, logout)\n- **MEDIUM**: Suspicious activities (rate limiting)\n- **HIGH**: Detected attacks (injection attempts)\n- **CRITICAL**: Severe security incidents\n\n### Log Format\n```json\n{\n  \"timestamp\": \"2025-01-01T00:00:00.000Z\",\n  \"eventType\": \"login_attempt\",\n  \"severity\": \"info\",\n  \"details\": {\n    \"userId\": \"user123\",\n    \"ip\": \"192.168.1.1\",\n    \"userAgent\": \"Mozilla/5.0...\"\n  }\n}\n```\n\n## Best Practices Implemented\n\n### Authentication\n- Strong password requirements with complexity validation\n- Account lockout after failed attempts\n- Session management with secure session IDs\n- Token blacklisting on logout\n- Password change forces re-authentication\n\n### Authorization\n- Role-based access control\n- Resource-based authorization\n- Session validation on each request\n- Token expiration and refresh mechanisms\n\n### Data Protection\n- Input sanitization on all endpoints\n- SQL/NoSQL injection prevention\n- XSS attack prevention\n- CSRF protection via SameSite cookies\n- Secure cookie configuration\n\n## Deployment Considerations\n\n### Production Settings\n1. Set `NODE_ENV=production`\n2. Use strong, unique JWT secrets\n3. Enable HTTPS with proper SSL certificates\n4. Configure proper CORS origins\n5. Set up proper logging and monitoring\n6. Enable IP verification if network is stable\n\n### Monitoring\n- Monitor security logs for unusual patterns\n- Set up alerts for critical security events\n- Regular security audits and updates\n- Monitor rate limiting effectiveness\n\n## Testing Security\n\n### Basic Security Test\n```bash\n# Test rate limiting\nfor i in {1..20}; do curl -X POST http://localhost:5000/api/auth/login; done\n\n# Test XSS protection\ncurl -X POST http://localhost:5000/api/auth/login \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"email\":\"test@test.com\",\"password\":\"<script>alert(1)</script>\"}'\n```\n\n### Security Headers Test\n```bash\n# Check security headers\ncurl -I http://localhost:5000/api/health\n```\n\nYou should see headers like:\n- `X-Content-Type-Options: nosniff`\n- `X-Frame-Options: DENY`\n- `Strict-Transport-Security: max-age=31536000; includeSubDomains; preload`\n\n## Troubleshooting\n\n### Common Issues\n\n1. **Token verification fails**: Check JWT_SECRET configuration\n2. **CORS issues**: Verify CLIENT_URL in environment\n3. **Rate limiting too strict**: Adjust limits in security.js\n4. **IP verification issues**: Disable VERIFY_IP_ADDRESS for mobile users\n\n### Debug Mode\nSet `LOG_LEVEL=debug` in environment to see detailed security logs.\n\n## Updates and Maintenance\n\n- Regularly update dependencies\n- Review security logs weekly\n- Update security configurations based on new threats\n- Test security measures after updates\n- Keep JWT secrets secure and rotate regularly\n\n## Support\n\nFor security-related questions or to report vulnerabilities, please check the security documentation or create an issue in the repository.\n